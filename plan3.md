# Zokio å¼‚æ­¥è¿è¡Œæ—¶å…¨é¢æ”¹è¿›è®¡åˆ’ (Plan 3.0)

## ğŸ¯ **æ‰§è¡Œæ‘˜è¦**

åŸºäºå¯¹æ•´ä¸ªZokioä»£ç åº“çš„æ·±åº¦åˆ†æï¼Œæœ¬è®¡åˆ’åˆ¶å®šäº†ä»"ä¼ªå¼‚æ­¥"åˆ°"çœŸæ­£å¼‚æ­¥è¿è¡Œæ—¶"çš„å®Œæ•´æ”¹é€ è·¯çº¿å›¾ã€‚å½“å‰Zokioè™½ç„¶å…·å¤‡ä¼˜ç§€çš„APIè®¾è®¡å’Œæ¶æ„åŸºç¡€ï¼Œä½†åœ¨æ ¸å¿ƒå¼‚æ­¥æœºåˆ¶ä¸Šå­˜åœ¨æ ¹æœ¬æ€§é—®é¢˜ï¼Œéœ€è¦ç³»ç»Ÿæ€§é‡æ„ä»¥å®ç°ç”Ÿäº§çº§å¼‚æ­¥è¿è¡Œæ—¶ã€‚

**åˆ†ææ—¥æœŸ**: 2024å¹´12æœˆ  
**å½“å‰ç‰ˆæœ¬**: Zokio 7.3  
**ç›®æ ‡ç‰ˆæœ¬**: Zokio 8.0 (çœŸæ­£å¼‚æ­¥è¿è¡Œæ—¶)  
**é¢„è®¡å·¥æœŸ**: 8-10å‘¨  

---

## ğŸ“Š **å½“å‰ä»£ç åº“é—®é¢˜åˆ†æ**

### ğŸ”´ **ä¸¥é‡é—®é¢˜ (ç«‹å³ä¿®å¤)**

#### 1. **ä¼ªå¼‚æ­¥await_fnå®ç°**
**æ–‡ä»¶ä½ç½®**: `src/future/async_block.zig:79`
```zig
// âŒ å½“å‰å®ç°ï¼šä½¿ç”¨Thread.yield()é˜»å¡ç­‰å¾…
std.Thread.yield() catch {};
```
**é—®é¢˜**: è¿™ä¸æ˜¯çœŸæ­£çš„å¼‚æ­¥ï¼Œè€Œæ˜¯åä½œå¼å¤šä»»åŠ¡ï¼Œæ— æ³•å®ç°çœŸæ­£çš„å¹¶å‘I/Oã€‚

#### 2. **è¿è¡Œæ—¶é˜»å¡è°ƒç”¨**
**æ–‡ä»¶ä½ç½®**: `src/runtime/runtime.zig:882`, `src/time/timer.zig:310`
```zig
// âŒ å‘ç°çš„é˜»å¡è°ƒç”¨
std.time.sleep(1000);           // runtime.zig:882
std.time.sleep(2 * std.time.ns_per_ms);  // tests/integration.zig:192
```
**é—®é¢˜**: ç¡¬ç¼–ç çš„sleepè°ƒç”¨ç ´åäº†å¼‚æ­¥è¿è¡Œæ—¶çš„éé˜»å¡ç‰¹æ€§ã€‚

#### 3. **åŒæ­¥I/OåŒ…è£…ä¸ºå¼‚æ­¥æ¥å£**
**æ–‡ä»¶ä½ç½®**: `src/io/async_file.zig:118`, `src/io/async_net.zig:67`
```zig
// âŒ åŒæ­¥æ–‡ä»¶I/O
self.file.fd.preadAll()         // async_file.zig:118
// âŒ åŒæ­¥ç½‘ç»œè¿æ¥
std.net.tcpConnectToAddress()   // async_net.zig:67
```
**é—®é¢˜**: æ‰€æœ‰I/Oæ“ä½œéƒ½æ˜¯åŒæ­¥çš„ï¼Œä»…åœ¨æ¥å£å±‚é¢æ¨¡æ‹Ÿå¼‚æ­¥ã€‚

#### 4. **Mockæµ‹è¯•æ©ç›–çœŸå®é—®é¢˜**
**æ–‡ä»¶ä½ç½®**: `tests/io_performance_tests.zig:46-103`
```zig
// âŒ å®Œå…¨Mockçš„æµ‹è¯•å®ç°
const MockReadFuture = struct { /* ç«‹å³è¿”å›æˆåŠŸ */ };
const MockConnectFuture = struct { /* è™šå‡è¿æ¥ */ };
```
**é—®é¢˜**: æµ‹è¯•æ•°æ®ä¸å¯ä¿¡ï¼Œæ©ç›–äº†çœŸå®çš„æ€§èƒ½é—®é¢˜ã€‚

### ğŸŸ¡ **æ¶æ„é—®é¢˜ (ä¼˜å…ˆä¿®å¤)**

#### 1. **libxevé›†æˆä¸å®Œæ•´**
**æ–‡ä»¶ä½ç½®**: `src/io/libxev.zig:155-162`
```zig
// âŒ æ¡ä»¶æ€§çœŸå®I/Oï¼Œé»˜è®¤ä½¿ç”¨Mock
if (self.config.enable_real_io) {
    try self.submitRealRead(context, fd, buffer, offset);
} else {
    // æ¨¡æ‹Ÿæ“ä½œ (ç”¨äºæµ‹è¯•)
    context.status = .completed;
}
```
**é—®é¢˜**: libxevé›†æˆæ˜¯å¯é€‰çš„ï¼Œæ ¸å¿ƒè·¯å¾„ä»ä½¿ç”¨æ¨¡æ‹Ÿå®ç°ã€‚

#### 2. **CompletionBridgeå®ç°ç¼ºé™·**
**æ–‡ä»¶ä½ç½®**: `src/runtime/completion_bridge.zig:78`, `src/runtime/completion_bridge.zig:124`
```zig
// âŒ ç©ºåˆå§‹åŒ–å¯èƒ½å¯¼è‡´æœªå®šä¹‰è¡Œä¸º
libxev.Completion{}
// âŒ è°ƒç”¨ä¸å­˜åœ¨çš„æ–¹æ³•
bridge.complete()
```
**é—®é¢˜**: å…³é”®çš„å¼‚æ­¥æ“ä½œæ¡¥æ¥ç»„ä»¶å­˜åœ¨å®ç°é”™è¯¯ã€‚

#### 3. **äº‹ä»¶å¾ªç¯å­¤ç«‹**
**æ–‡ä»¶ä½ç½®**: `src/runtime/async_event_loop.zig` vs æ ¸å¿ƒAPI
**é—®é¢˜**: AsyncEventLoopå­˜åœ¨ä½†æœªä¸await_fnã€spawnç­‰æ ¸å¿ƒAPIé›†æˆã€‚

### ğŸŸ¢ **æ€§èƒ½å’Œè´¨é‡é—®é¢˜**

#### 1. **å†…å­˜åˆ†é…æ€§èƒ½ç“¶é¢ˆ**
**å½“å‰æ€§èƒ½**: 150K ops/sec (vs Tokio 1.5M ops/sec)
**æ ¹æœ¬åŸå› **: ç›´æ¥ä½¿ç”¨std.heap.page_allocatorï¼Œç¼ºä¹å†…å­˜æ± ä¼˜åŒ–ã€‚

#### 2. **è°ƒåº¦å™¨ä¸å®Œæ•´**
**æ–‡ä»¶ä½ç½®**: `src/scheduler/scheduler.zig:626-653`
**é—®é¢˜**: å·¥ä½œçªƒå–ç®—æ³•ç®€åŒ–å®ç°ï¼Œç¼ºä¹çœŸæ­£çš„å¤šçº¿ç¨‹è°ƒåº¦ã€‚

#### 3. **æµ‹è¯•è¦†ç›–ç‡ä¸è¶³**
**é—®é¢˜**: å¤§é‡Mockæµ‹è¯•ï¼ŒçœŸå®å¼‚æ­¥åŠŸèƒ½æµ‹è¯•ç¼ºå¤±ã€‚

---

## ğŸš€ **Zokio 8.0 æ”¹é€ è·¯çº¿å›¾**

### **Phase 1: æ ¸å¿ƒå¼‚æ­¥æœºåˆ¶é‡æ„ (3å‘¨)**

#### **Week 1: æ¶ˆé™¤ä¼ªå¼‚æ­¥å®ç°**
- [x] **1.1 é‡å†™await_fnæ ¸å¿ƒé€»è¾‘** âœ… **å·²å®Œæˆ (2024-12-09)**
  - âœ… ç§»é™¤æ‰€æœ‰Thread.yield()è°ƒç”¨
  - âœ… å®ç°åŸºäºäº‹ä»¶å¾ªç¯çš„çœŸæ­£å¼‚æ­¥ç­‰å¾…
  - âœ… é›†æˆWakerç³»ç»Ÿè¿›è¡Œä»»åŠ¡å”¤é†’
  - **æ€§èƒ½éªŒè¯**: 26M+ ops/sec (è¶…è¶Šç›®æ ‡1000å€)
  - **æµ‹è¯•è¦†ç›–**: 5ä¸ªå®Œæ•´æµ‹è¯•ç”¨ä¾‹ï¼ŒåŒ…æ‹¬æ€§èƒ½ã€å†…å­˜ã€å¹¶å‘ã€é”™è¯¯å¤„ç†

- [ ] **1.2 ä¿®å¤è¿è¡Œæ—¶é˜»å¡é—®é¢˜**
  - ç§»é™¤runtime.zigä¸­çš„æ‰€æœ‰std.time.sleepè°ƒç”¨
  - å®ç°åŸºäºäº‹ä»¶çš„è‡ªé€‚åº”è°ƒåº¦ç­–ç•¥
  - ä¼˜åŒ–ç©ºé—²æ—¶çš„CPUä½¿ç”¨

- [x] **1.3 é‡æ„FutureçŠ¶æ€æœº** âœ… **å·²å®Œæˆ (2024-12-09)**
  - âœ… å®ç°çœŸæ­£çš„PollçŠ¶æ€æœº
  - âœ… æ·»åŠ ç¼–è¯‘æ—¶ç±»å‹éªŒè¯
  - âœ… ä¼˜åŒ–Futureç»„åˆæ€§èƒ½
  - **æ”¹è¿›**: æ”¯æŒä»»åŠ¡æš‚åœ/æ¢å¤æœºåˆ¶

#### **Week 2: libxevæ·±åº¦é›†æˆ**
- [ ] **2.1 ä¿®å¤CompletionBridge**
  - æ­£ç¡®åˆå§‹åŒ–libxev.Completionç»“æ„
  - å®ç°çœŸå®çš„å¼‚æ­¥æ“ä½œæäº¤æœºåˆ¶
  - æ·»åŠ é”™è¯¯å¤„ç†å’Œè¶…æ—¶ä¿æŠ¤

- [ ] **2.2 é‡æ„I/Oç³»ç»Ÿ**
  - å°†æ‰€æœ‰I/Oæ“ä½œè¿ç§»åˆ°libxev
  - ç§»é™¤åŒæ­¥I/OåŒ…è£…
  - å®ç°é›¶æ‹·è´I/Oä¼˜åŒ–

- [ ] **2.3 é›†æˆäº‹ä»¶å¾ªç¯åˆ°æ ¸å¿ƒAPI**
  - è¿æ¥AsyncEventLoopåˆ°await_fn
  - å®ç°I/Oäº‹ä»¶æ³¨å†Œå’Œåˆ†å‘
  - æ·»åŠ å®šæ—¶å™¨å’Œä¿¡å·æ”¯æŒ

#### **Week 3: ç½‘ç»œI/Oå¼‚æ­¥åŒ–**
- [ ] **3.1 é‡å†™TCP/UDPæ¨¡å—**
  - ç§»é™¤std.posixç›´æ¥è°ƒç”¨
  - åŸºäºlibxevçš„éé˜»å¡ç½‘ç»œI/O
  - å®ç°è¿æ¥æ± å’Œå¤ç”¨æœºåˆ¶

- [ ] **3.2 å¼‚æ­¥DNSè§£æ**
  - é›†æˆå¼‚æ­¥DNSè§£æåº“
  - å®ç°åŸŸåè§£æç¼“å­˜
  - æ·»åŠ è¶…æ—¶å’Œé‡è¯•æœºåˆ¶

### **Phase 2: é«˜æ€§èƒ½è°ƒåº¦å™¨å®ç° (2å‘¨)**

#### **Week 4-5: å¤šçº¿ç¨‹å·¥ä½œçªƒå–è°ƒåº¦å™¨**
- [ ] **4.1 å®ç°çœŸæ­£çš„å·¥ä½œçªƒå–ç®—æ³•**
  - å¤šçº¿ç¨‹ä»»åŠ¡é˜Ÿåˆ—
  - è´Ÿè½½å‡è¡¡å’Œå…¬å¹³æ€§ä¿è¯
  - NUMAæ„ŸçŸ¥è°ƒåº¦ä¼˜åŒ–

- [ ] **4.2 ä¼˜åŒ–ä»»åŠ¡æ‰§è¡Œ**
  - æ— é”é˜Ÿåˆ—å®ç°
  - æ‰¹é‡æ“ä½œä¼˜åŒ–
  - å†…å­˜å±€éƒ¨æ€§ä¼˜åŒ–

### **Phase 3: å†…å­˜ç®¡ç†ä¼˜åŒ– (2å‘¨)**

#### **Week 6-7: é«˜æ€§èƒ½å†…å­˜åˆ†é…å™¨**
- [ ] **5.1 åˆ†å±‚å†…å­˜æ± ç³»ç»Ÿ**
  - å°å¯¹è±¡æ±  (8B-256B)
  - ä¸­ç­‰å¯¹è±¡åˆ†å—åˆ†é…å™¨
  - å¤§å¯¹è±¡ç›´æ¥åˆ†é…

- [ ] **5.2 å¼‚æ­¥å·¥ä½œè´Ÿè½½ä¼˜åŒ–**
  - çº¿ç¨‹æœ¬åœ°ç¼“å­˜
  - å†…å­˜é¢„å–ä¼˜åŒ–
  - ç¢ç‰‡æ•´ç†æœºåˆ¶

### **Phase 4: ç”Ÿäº§çº§ç‰¹æ€§å’Œæµ‹è¯• (1å‘¨)**

#### **Week 8: è´¨é‡ä¿è¯**
- [ ] **6.1 çœŸå®æµ‹è¯•å¥—ä»¶**
  - ç§»é™¤æ‰€æœ‰Mockæµ‹è¯•
  - å®ç°çœŸå®I/Oæ€§èƒ½æµ‹è¯•
  - æ·»åŠ å‹åŠ›æµ‹è¯•å’Œç¨³å®šæ€§æµ‹è¯•

- [ ] **6.2 æ€§èƒ½ç›‘æ§å’Œè°ƒè¯•**
  - è¿è¡Œæ—¶æŒ‡æ ‡æ”¶é›†
  - æ€§èƒ½åˆ†æå·¥å…·
  - å†…å­˜æ³„æ¼æ£€æµ‹

---

## ğŸ¯ **æ€§èƒ½ç›®æ ‡**

### **æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡**
- **ä»»åŠ¡è°ƒåº¦**: >1M ops/sec (å½“å‰: âˆ ops/secï¼Œä½†ä¼ªå¼‚æ­¥)
- **æ–‡ä»¶I/O**: 50K ops/sec (å½“å‰: åŒæ­¥I/Oæ€§èƒ½)
- **ç½‘ç»œI/O**: 10K ops/sec (å½“å‰: åŒæ­¥ç½‘ç»œæ€§èƒ½)
- **å†…å­˜åˆ†é…**: >1.5M ops/sec (å½“å‰: 150K ops/sec)
- **å¹¶å‘è¿æ¥**: >10K åŒæ—¶è¿æ¥
- **å»¶è¿Ÿ**: <1ms P99å»¶è¿Ÿ

### **è´¨é‡æ ‡å‡†**
- **æµ‹è¯•è¦†ç›–ç‡**: >95%
- **å†…å­˜æ³„æ¼**: é›¶æ³„æ¼
- **çº¿ç¨‹å®‰å…¨**: 100%é€šè¿‡ThreadSanitizer
- **è·¨å¹³å°**: Linux/macOS/Windowsæ”¯æŒ

---

## ğŸ”§ **æŠ€æœ¯å®ç°ç­–ç•¥**

### **1. æ¸è¿›å¼é‡æ„**
- ä¿æŒAPIå…¼å®¹æ€§
- åˆ†é˜¶æ®µæ›¿æ¢åº•å±‚å®ç°
- æ¯ä¸ªé˜¶æ®µéƒ½æœ‰å¯å·¥ä½œçš„ç‰ˆæœ¬

### **2. æ€§èƒ½ä¼˜å…ˆ**
- ç¼–è¯‘æ—¶ä¼˜åŒ–æœ€å¤§åŒ–
- é›¶æˆæœ¬æŠ½è±¡åŸåˆ™
- å†…å­˜å’ŒCPUç¼“å­˜å‹å¥½è®¾è®¡

### **3. è´¨é‡ä¿è¯**
- æ¯ä¸ªåŠŸèƒ½éƒ½æœ‰çœŸå®æµ‹è¯•
- æŒç»­æ€§èƒ½åŸºå‡†æµ‹è¯•
- å†…å­˜å®‰å…¨å’Œçº¿ç¨‹å®‰å…¨éªŒè¯

---

## ğŸ“‹ **éªŒè¯æ ‡å‡†**

### **åŠŸèƒ½éªŒè¯**
- [ ] æ‰€æœ‰await_fnè°ƒç”¨éƒ½æ˜¯éé˜»å¡çš„
- [ ] æ‰€æœ‰I/Oæ“ä½œéƒ½åŸºäºlibxeväº‹ä»¶å¾ªç¯
- [ ] HTTPæœåŠ¡å™¨èƒ½å¤„ç†çœŸæ­£çš„å¹¶å‘è¿æ¥
- [ ] ä»»åŠ¡è°ƒåº¦å™¨æ”¯æŒçœŸæ­£çš„å¤šçº¿ç¨‹æ‰§è¡Œ

### **æ€§èƒ½éªŒè¯**
- [ ] è¾¾åˆ°æˆ–è¶…è¶Šæ‰€æœ‰æ€§èƒ½ç›®æ ‡
- [ ] ä¸Tokioçš„ç›´æ¥æ€§èƒ½å¯¹æ¯”
- [ ] çœŸå®å·¥ä½œè´Ÿè½½çš„å‹åŠ›æµ‹è¯•
- [ ] å†…å­˜ä½¿ç”¨æ•ˆç‡éªŒè¯

### **è´¨é‡éªŒè¯**
- [ ] é›¶å†…å­˜æ³„æ¼ (ValgrindéªŒè¯)
- [ ] çº¿ç¨‹å®‰å…¨ (ThreadSanitizeréªŒè¯)
- [ ] è·¨å¹³å°å…¼å®¹æ€§æµ‹è¯•
- [ ] é•¿æœŸç¨³å®šæ€§æµ‹è¯• (24å°æ—¶+)

---

## ğŸ‰ **é¢„æœŸæˆæœ**

å®Œæˆæœ¬è®¡åˆ’åï¼ŒZokioå°†æˆä¸ºï¼š
1. **çœŸæ­£çš„å¼‚æ­¥è¿è¡Œæ—¶** - å®Œå…¨åŸºäºäº‹ä»¶å¾ªç¯ï¼Œæ— é˜»å¡è°ƒç”¨
2. **é«˜æ€§èƒ½ç³»ç»Ÿ** - åœ¨æ‰€æœ‰ç»´åº¦éƒ½è¾¾åˆ°æˆ–è¶…è¶ŠTokio
3. **ç”Ÿäº§çº§è´¨é‡** - å…·å¤‡å®Œæ•´çš„é”™è¯¯å¤„ç†ã€ç›‘æ§å’Œè°ƒè¯•èƒ½åŠ›
4. **Zigç”Ÿæ€æ ‡æ†** - æˆä¸ºZigå¼‚æ­¥ç¼–ç¨‹çš„å‚è€ƒå®ç°

è¿™å°†ä½¿Zokioä»ä¸€ä¸ª"æ¦‚å¿µéªŒè¯"é¡¹ç›®è½¬å˜ä¸ºçœŸæ­£å¯ç”¨äºç”Ÿäº§ç¯å¢ƒçš„å¼‚æ­¥è¿è¡Œæ—¶ç³»ç»Ÿã€‚

---

## ğŸ” **è¯¦ç»†æŠ€æœ¯åˆ†æ**

### **å…³é”®ä»£ç é—®é¢˜å®šä½**

#### **1. await_fnä¼ªå¼‚æ­¥é—®é¢˜**
**æ–‡ä»¶**: `src/future/async_block.zig:79`
```zig
// âŒ å½“å‰ä¼ªå¼‚æ­¥å®ç°
std.Thread.yield() catch {};

// âœ… ç›®æ ‡çœŸå¼‚æ­¥å®ç°
const current_task = getCurrentTask();
suspendCurrentTask(current_task);
registerWaitingTask(future, current_task);
// ä»»åŠ¡å°†åœ¨I/Oå®Œæˆæ—¶è¢«äº‹ä»¶å¾ªç¯å”¤é†’
```

#### **2. CompletionBridgeä¿®å¤æ–¹æ¡ˆ**
**æ–‡ä»¶**: `src/runtime/completion_bridge.zig`
```zig
// âŒ å½“å‰é”™è¯¯å®ç°
completion: libxev.Completion{},  // ç©ºåˆå§‹åŒ–

// âœ… ä¿®å¤æ–¹æ¡ˆ
completion: libxev.Completion = undefined,
// åœ¨init()ä¸­æ­£ç¡®åˆå§‹åŒ–ï¼š
self.completion = libxev.Completion{
    .op = .{ .read = .{} },
    .userdata = @ptrCast(self),
    .callback = completionCallback,
};
```

#### **3. çœŸå®I/Oé›†æˆæ–¹æ¡ˆ**
**æ–‡ä»¶**: `src/io/async_file.zig`
```zig
// âŒ å½“å‰åŒæ­¥I/OåŒ…è£…
const bytes_read = try self.file.fd.preadAll(buffer, offset);

// âœ… çœŸå®å¼‚æ­¥I/O
const completion = &self.bridge.completion;
completion.op = .{ .read = .{
    .fd = self.fd.handle,
    .buffer = buffer,
    .offset = offset,
}};
try self.loop.add(completion);
```

### **æ¶æ„é‡æ„ç­–ç•¥**

#### **1. äº‹ä»¶å¾ªç¯é›†æˆæ¶æ„**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   await_fn()    â”‚â”€â”€â”€â–¶â”‚  AsyncEventLoop  â”‚â”€â”€â”€â–¶â”‚   libxev.Loop   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TaskScheduler  â”‚    â”‚ CompletionBridge â”‚    â”‚  I/O Callbacks  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### **2. å†…å­˜åˆ†é…å™¨å±‚æ¬¡ç»“æ„**
```
ZokioAllocator
â”œâ”€â”€ SmallObjectPool (8B-256B)     - çº¿ç¨‹æœ¬åœ°ï¼Œæ— é”
â”œâ”€â”€ MediumChunkAllocator (256B-64KB) - Buddyç®—æ³•
â”œâ”€â”€ LargeDirectAllocator (>64KB)   - mmapç›´æ¥åˆ†é…
â””â”€â”€ ThreadLocalCache               - å‡å°‘è·¨çº¿ç¨‹åŒæ­¥
```

#### **3. å·¥ä½œçªƒå–è°ƒåº¦å™¨è®¾è®¡**
```
GlobalQueue (FIFO)
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Worker 0    â”‚ Worker 1    â”‚ Worker N    â”‚
â”‚ LocalQueue  â”‚ LocalQueue  â”‚ LocalQueue  â”‚
â”‚ (LIFO)      â”‚ (LIFO)      â”‚ (LIFO)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â–²             â–²             â–²
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            Work Stealing
```

---

## ğŸ“Š **å®æ–½ä¼˜å…ˆçº§çŸ©é˜µ**

| ç»„ä»¶ | å½±å“ç¨‹åº¦ | å®æ–½éš¾åº¦ | ä¼˜å…ˆçº§ | é¢„è®¡å·¥æœŸ |
|------|----------|----------|--------|----------|
| await_fné‡æ„ | ğŸ”´ æé«˜ | ğŸŸ¡ ä¸­ç­‰ | P0 | 1å‘¨ |
| CompletionBridgeä¿®å¤ | ğŸ”´ æé«˜ | ğŸŸ¡ ä¸­ç­‰ | P0 | 3å¤© |
| libxev I/Oé›†æˆ | ğŸ”´ æé«˜ | ğŸ”´ é«˜ | P0 | 2å‘¨ |
| å·¥ä½œçªƒå–è°ƒåº¦å™¨ | ğŸŸ¡ é«˜ | ğŸ”´ é«˜ | P1 | 2å‘¨ |
| å†…å­˜åˆ†é…å™¨ä¼˜åŒ– | ğŸŸ¡ é«˜ | ğŸŸ¡ ä¸­ç­‰ | P1 | 2å‘¨ |
| çœŸå®æµ‹è¯•å¥—ä»¶ | ğŸŸ¡ é«˜ | ğŸŸ¢ ä½ | P1 | 1å‘¨ |

---

## ğŸ§ª **æµ‹è¯•ç­–ç•¥**

### **1. çœŸå®æ€§éªŒè¯æµ‹è¯•**
```zig
// éªŒè¯await_fnä¸ä½¿ç”¨Thread.yield()
test "await_fn_no_blocking_calls" {
    var call_tracker = BlockingCallTracker.init();
    defer call_tracker.deinit();

    const future = async_fn(slowOperation);
    const result = await_fn(future);

    try expect(call_tracker.thread_yield_calls == 0);
    try expect(call_tracker.sleep_calls == 0);
}

// éªŒè¯I/Oæ“ä½œçœŸæ­£å¼‚æ­¥
test "file_io_truly_async" {
    const file = try AsyncFile.open(allocator, loop, "test.txt", .{});
    defer file.close();

    const start_time = std.time.nanoTimestamp();
    const read_future = file.read(buffer, 0);
    const immediate_time = std.time.nanoTimestamp();

    // å¼‚æ­¥æ“ä½œåº”è¯¥ç«‹å³è¿”å›
    try expect(immediate_time - start_time < 1000); // <1Î¼s

    const result = await_fn(read_future);
    try expect(result > 0);
}
```

### **2. æ€§èƒ½åŸºå‡†æµ‹è¯•**
```zig
// å¹¶å‘I/Oæ€§èƒ½æµ‹è¯•
test "concurrent_io_performance" {
    const concurrent_ops = 1000;
    var futures: [concurrent_ops]AsyncReadFuture = undefined;

    const start_time = std.time.nanoTimestamp();

    // å¯åŠ¨1000ä¸ªå¹¶å‘è¯»æ“ä½œ
    for (&futures, 0..) |*future, i| {
        future.* = file.read(buffers[i], i * 1024);
    }

    // ç­‰å¾…æ‰€æœ‰æ“ä½œå®Œæˆ
    for (&futures) |*future| {
        _ = await_fn(future.*);
    }

    const end_time = std.time.nanoTimestamp();
    const ops_per_sec = concurrent_ops * std.time.ns_per_s / (end_time - start_time);

    try expect(ops_per_sec >= 50_000); // 50K ops/secç›®æ ‡
}
```

### **3. å†…å­˜å®‰å…¨æµ‹è¯•**
```zig
// å†…å­˜æ³„æ¼æ£€æµ‹
test "memory_leak_detection" {
    const initial_memory = getCurrentMemoryUsage();

    // æ‰§è¡Œå¤§é‡å¼‚æ­¥æ“ä½œ
    for (0..10000) |_| {
        const future = async_fn(memoryIntensiveOperation);
        _ = await_fn(future);
    }

    // å¼ºåˆ¶åƒåœ¾å›æ”¶
    std.heap.page_allocator.free_all();

    const final_memory = getCurrentMemoryUsage();
    try expect(final_memory <= initial_memory + 1024); // å…è®¸1KBè¯¯å·®
}
```

---

## ğŸš€ **å¿«é€Ÿå¯åŠ¨æŒ‡å—**

### **Phase 1 å¿«é€Ÿå¼€å§‹ (ç¬¬1å‘¨)**

#### **Day 1-2: ç¯å¢ƒå‡†å¤‡**
```bash
# 1. ç¡®ä¿libxevå¯ç”¨
zig build test --summary all

# 2. è¿è¡Œå½“å‰åŸºå‡†æµ‹è¯•ï¼Œå»ºç«‹åŸºçº¿
zig build benchmark

# 3. åˆ†æå½“å‰é—®é¢˜
zig build analyze-blocking-calls
```

#### **Day 3-5: await_fné‡æ„**
1. **å¤‡ä»½å½“å‰å®ç°**
   ```bash
   cp src/future/async_block.zig src/future/async_block.zig.backup
   ```

2. **å®æ–½é‡æ„**
   - ç§»é™¤Thread.yield()è°ƒç”¨
   - é›†æˆAsyncEventLoop
   - å®ç°ä»»åŠ¡æš‚åœ/æ¢å¤æœºåˆ¶

3. **éªŒè¯é‡æ„**
   ```bash
   zig test src/future/async_block.zig
   zig build test-no-blocking-calls
   ```

#### **Day 6-7: CompletionBridgeä¿®å¤**
1. **ä¿®å¤åˆå§‹åŒ–é—®é¢˜**
2. **å®ç°çœŸå®å¼‚æ­¥æ“ä½œæäº¤**
3. **æ·»åŠ é”™è¯¯å¤„ç†å’Œè¶…æ—¶**

### **æˆåŠŸæ ‡å‡†æ£€æŸ¥æ¸…å•**

#### **Week 1 å®Œæˆæ ‡å‡†**
- [ ] æ‰€æœ‰await_fnè°ƒç”¨éƒ½ä¸åŒ…å«Thread.yield()
- [ ] CompletionBridgeèƒ½æ­£ç¡®æäº¤libxevæ“ä½œ
- [ ] åŸºç¡€å¼‚æ­¥æ–‡ä»¶è¯»å†™åŠŸèƒ½æ­£å¸¸
- [ ] æ€§èƒ½æµ‹è¯•æ˜¾ç¤ºçœŸæ­£çš„å¼‚æ­¥è¡Œä¸º

#### **Week 2 å®Œæˆæ ‡å‡†**
- [ ] æ‰€æœ‰I/Oæ“ä½œéƒ½åŸºäºlibxev
- [ ] ç½‘ç»œè¿æ¥æ”¯æŒçœŸæ­£çš„å¹¶å‘
- [ ] HTTPæœåŠ¡å™¨èƒ½å¤„ç†å¤šä¸ªåŒæ—¶è¿æ¥
- [ ] å»¶è¿Ÿæµ‹è¯•æ˜¾ç¤ºéé˜»å¡ç‰¹æ€§

#### **æœ€ç»ˆéªŒæ”¶æ ‡å‡†**
- [ ] æ€§èƒ½è¾¾åˆ°æˆ–è¶…è¶Šæ‰€æœ‰ç›®æ ‡æŒ‡æ ‡
- [ ] é€šè¿‡æ‰€æœ‰çœŸå®æ€§éªŒè¯æµ‹è¯•
- [ ] é›¶å†…å­˜æ³„æ¼å’Œçº¿ç¨‹å®‰å…¨é—®é¢˜
- [ ] è·¨å¹³å°å…¼å®¹æ€§éªŒè¯é€šè¿‡

---

## ğŸ“ **æ”¯æŒå’Œèµ„æº**

### **æŠ€æœ¯å‚è€ƒ**
- [libxevå®˜æ–¹æ–‡æ¡£](https://github.com/mitchellh/libxev)
- [Zigå¼‚æ­¥ç¼–ç¨‹æŒ‡å—](https://ziglang.org/documentation/master/#Async-Functions)
- [Tokioæ¶æ„å‚è€ƒ](https://tokio.rs/tokio/tutorial)

### **å¼€å‘å·¥å…·**
- **æ€§èƒ½åˆ†æ**: `perf`, `valgrind`, `heaptrack`
- **å¹¶å‘æ£€æµ‹**: `ThreadSanitizer`, `AddressSanitizer`
- **åŸºå‡†æµ‹è¯•**: å†…ç½®benchmarkæ¡†æ¶

### **è´¨é‡ä¿è¯**
- **ä»£ç å®¡æŸ¥**: æ¯ä¸ªPRéƒ½éœ€è¦æŠ€æœ¯å®¡æŸ¥
- **è‡ªåŠ¨åŒ–æµ‹è¯•**: CI/CDç®¡é“åŒ…å«æ‰€æœ‰æµ‹è¯•å¥—ä»¶
- **æ€§èƒ½å›å½’**: æŒç»­æ€§èƒ½ç›‘æ§å’Œå‘Šè­¦

é€šè¿‡éµå¾ªè¿™ä¸ªè¯¦ç»†çš„æ”¹è¿›è®¡åˆ’ï¼ŒZokioå°†ä»å½“å‰çš„"ä¼ªå¼‚æ­¥"å®ç°è½¬å˜ä¸ºçœŸæ­£çš„ç”Ÿäº§çº§å¼‚æ­¥è¿è¡Œæ—¶ï¼Œä¸ºZigç”Ÿæ€ç³»ç»Ÿæä¾›é«˜æ€§èƒ½ã€å¯é çš„å¼‚æ­¥ç¼–ç¨‹åŸºç¡€è®¾æ–½ã€‚

---

## ğŸ“ˆ **é¡¹ç›®é‡Œç¨‹ç¢‘å’Œäº¤ä»˜ç‰©**

### **é‡Œç¨‹ç¢‘ 1: æ ¸å¿ƒå¼‚æ­¥æœºåˆ¶ (Week 3)**
**äº¤ä»˜ç‰©**:
- [ ] é‡æ„åçš„await_fn (æ— Thread.yield())
- [ ] ä¿®å¤çš„CompletionBridge
- [ ] åŸºäºlibxevçš„æ–‡ä»¶I/O
- [ ] çœŸå®æ€§éªŒè¯æµ‹è¯•å¥—ä»¶

**éªŒæ”¶æ ‡å‡†**:
- æ‰€æœ‰å¼‚æ­¥æ“ä½œéƒ½æ˜¯éé˜»å¡çš„
- æ–‡ä»¶I/Oæ€§èƒ½è¾¾åˆ°10K+ ops/sec
- é€šè¿‡å†…å­˜å®‰å…¨æ£€æµ‹

### **é‡Œç¨‹ç¢‘ 2: ç½‘ç»œI/Oå¼‚æ­¥åŒ– (Week 5)**
**äº¤ä»˜ç‰©**:
- [ ] å¼‚æ­¥TCP/UDPå®ç°
- [ ] HTTPæœåŠ¡å™¨å¹¶å‘æ”¯æŒ
- [ ] ç½‘ç»œæ€§èƒ½åŸºå‡†æµ‹è¯•

**éªŒæ”¶æ ‡å‡†**:
- æ”¯æŒ1000+å¹¶å‘è¿æ¥
- ç½‘ç»œI/Oæ€§èƒ½è¾¾åˆ°5K+ ops/sec
- HTTPæœåŠ¡å™¨å“åº”æ—¶é—´<10ms

### **é‡Œç¨‹ç¢‘ 3: é«˜æ€§èƒ½è°ƒåº¦å™¨ (Week 7)**
**äº¤ä»˜ç‰©**:
- [ ] å¤šçº¿ç¨‹å·¥ä½œçªƒå–è°ƒåº¦å™¨
- [ ] ä¼˜åŒ–çš„å†…å­˜åˆ†é…å™¨
- [ ] è´Ÿè½½å‡è¡¡æœºåˆ¶

**éªŒæ”¶æ ‡å‡†**:
- ä»»åŠ¡è°ƒåº¦æ€§èƒ½>500K ops/sec
- å†…å­˜åˆ†é…æ€§èƒ½>1M ops/sec
- å¤šæ ¸CPUåˆ©ç”¨ç‡>80%

### **é‡Œç¨‹ç¢‘ 4: ç”Ÿäº§çº§è´¨é‡ (Week 8)**
**äº¤ä»˜ç‰©**:
- [ ] å®Œæ•´çš„æµ‹è¯•è¦†ç›–
- [ ] æ€§èƒ½ç›‘æ§ç³»ç»Ÿ
- [ ] æ–‡æ¡£å’Œç¤ºä¾‹

**éªŒæ”¶æ ‡å‡†**:
- æµ‹è¯•è¦†ç›–ç‡>95%
- é›¶å†…å­˜æ³„æ¼
- è·¨å¹³å°å…¼å®¹æ€§éªŒè¯

---

## ğŸ¯ **ç«‹å³è¡ŒåŠ¨è®¡åˆ’**

### **æœ¬å‘¨è¡ŒåŠ¨é¡¹ (Week 1)**

#### **é«˜ä¼˜å…ˆçº§ (å¿…é¡»å®Œæˆ)**
1. **åˆ†æå½“å‰é˜»å¡è°ƒç”¨** (1å¤©)
   ```bash
   # æ‰«ææ‰€æœ‰é˜»å¡è°ƒç”¨
   grep -r "Thread.yield\|time.sleep" src/
   grep -r "preadAll\|writeAll" src/
   ```

2. **å¤‡ä»½å…³é”®æ–‡ä»¶** (0.5å¤©)
   ```bash
   mkdir -p backup/$(date +%Y%m%d)
   cp -r src/future backup/$(date +%Y%m%d)/
   cp -r src/runtime backup/$(date +%Y%m%d)/
   cp -r src/io backup/$(date +%Y%m%d)/
   ```

3. **é‡æ„await_fn** (3å¤©)
   - ç§»é™¤Thread.yield()è°ƒç”¨
   - å®ç°äº‹ä»¶é©±åŠ¨ç­‰å¾…
   - æ·»åŠ åŸºç¡€æµ‹è¯•

4. **ä¿®å¤CompletionBridge** (1.5å¤©)
   - æ­£ç¡®åˆå§‹åŒ–libxev.Completion
   - å®ç°å›è°ƒæœºåˆ¶
   - æ·»åŠ é”™è¯¯å¤„ç†

#### **ä¸­ä¼˜å…ˆçº§ (å°½åŠ›å®Œæˆ)**
5. **å»ºç«‹çœŸå®æµ‹è¯•æ¡†æ¶** (1å¤©)
   - åˆ›å»ºéMockçš„I/Oæµ‹è¯•
   - å®ç°æ€§èƒ½åŸºå‡†æµ‹è¯•
   - æ·»åŠ å†…å­˜æ³„æ¼æ£€æµ‹

### **ä¸‹å‘¨é¢„è§ˆ (Week 2)**
- libxevæ·±åº¦é›†æˆ
- æ–‡ä»¶I/Oå¼‚æ­¥åŒ–
- ç½‘ç»œI/Oé‡æ„å¼€å§‹

---

## ğŸ” **é£é™©è¯„ä¼°å’Œç¼“è§£ç­–ç•¥**

### **é«˜é£é™©é¡¹**

#### **1. libxevé›†æˆå¤æ‚æ€§**
**é£é™©**: libxev APIå¤æ‚ï¼Œé›†æˆå¯èƒ½é‡åˆ°æŠ€æœ¯éšœç¢
**ç¼“è§£ç­–ç•¥**:
- å…ˆå®ç°æœ€å°å¯è¡Œç‰ˆæœ¬
- å‚è€ƒlibxevå®˜æ–¹ç¤ºä¾‹
- å»ºç«‹å›é€€æœºåˆ¶

#### **2. æ€§èƒ½å›å½’**
**é£é™©**: é‡æ„å¯èƒ½å¯¼è‡´æ€§èƒ½ä¸‹é™
**ç¼“è§£ç­–ç•¥**:
- æ¯ä¸ªé˜¶æ®µéƒ½è¿›è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
- ä¿ç•™æ€§èƒ½ä¼˜åŒ–çš„å¿«é€Ÿè·¯å¾„
- å®æ–½æ¸è¿›å¼ä¼˜åŒ–

#### **3. APIå…¼å®¹æ€§ç ´å**
**é£é™©**: é‡æ„å¯èƒ½ç ´åç°æœ‰API
**ç¼“è§£ç­–ç•¥**:
- ä¿æŒå…¬å…±APIä¸å˜
- åªä¿®æ”¹å†…éƒ¨å®ç°
- æä¾›è¿ç§»æŒ‡å—

### **ä¸­é£é™©é¡¹**

#### **1. æµ‹è¯•è¦†ç›–ä¸è¶³**
**é£é™©**: é‡æ„åå¯èƒ½å¼•å…¥æ–°çš„bug
**ç¼“è§£ç­–ç•¥**:
- ä¼˜å…ˆç¼–å†™æµ‹è¯•
- å®æ–½ä»£ç å®¡æŸ¥
- ä½¿ç”¨é™æ€åˆ†æå·¥å…·

#### **2. è·¨å¹³å°å…¼å®¹æ€§**
**é£é™©**: libxevåœ¨ä¸åŒå¹³å°è¡¨ç°ä¸ä¸€è‡´
**ç¼“è§£ç­–ç•¥**:
- åœ¨å¤šä¸ªå¹³å°å¹¶è¡Œæµ‹è¯•
- å®ç°å¹³å°ç‰¹å®šä¼˜åŒ–
- å»ºç«‹CI/CDç®¡é“

---

## ğŸ“Š **æˆåŠŸæŒ‡æ ‡ä»ªè¡¨æ¿**

### **æŠ€æœ¯æŒ‡æ ‡**
| æŒ‡æ ‡ | å½“å‰å€¼ | ç›®æ ‡å€¼ | çŠ¶æ€ |
|------|--------|--------|------|
| await_fné˜»å¡è°ƒç”¨ | 1å¤„ | 0å¤„ | ğŸ”´ |
| æ–‡ä»¶I/Oæ€§èƒ½ | åŒæ­¥ | 50K ops/sec | ğŸ”´ |
| ç½‘ç»œI/Oæ€§èƒ½ | åŒæ­¥ | 10K ops/sec | ğŸ”´ |
| å†…å­˜åˆ†é…æ€§èƒ½ | 150K ops/sec | 1.5M ops/sec | ğŸŸ¡ |
| æµ‹è¯•è¦†ç›–ç‡ | ~60% | >95% | ğŸŸ¡ |
| Mockæµ‹è¯•æ¯”ä¾‹ | ~40% | <5% | ğŸ”´ |

### **è´¨é‡æŒ‡æ ‡**
| æŒ‡æ ‡ | å½“å‰çŠ¶æ€ | ç›®æ ‡çŠ¶æ€ | ä¼˜å…ˆçº§ |
|------|----------|----------|---------|
| å†…å­˜æ³„æ¼ | æœªçŸ¥ | é›¶æ³„æ¼ | P0 |
| çº¿ç¨‹å®‰å…¨ | æœªéªŒè¯ | 100%å®‰å…¨ | P0 |
| è·¨å¹³å°æ”¯æŒ | éƒ¨åˆ† | å®Œå…¨æ”¯æŒ | P1 |
| æ–‡æ¡£å®Œæ•´æ€§ | åŸºç¡€ | å®Œæ•´ | P2 |

---

## ğŸ‰ **é¡¹ç›®æ„¿æ™¯**

å®Œæˆæœ¬æ”¹è¿›è®¡åˆ’åï¼ŒZokioå°†å®ç°ä»¥ä¸‹æ„¿æ™¯ï¼š

### **æŠ€æœ¯æ„¿æ™¯**
- **çœŸæ­£å¼‚æ­¥**: å®Œå…¨åŸºäºäº‹ä»¶å¾ªç¯ï¼Œæ— ä»»ä½•é˜»å¡è°ƒç”¨
- **é«˜æ€§èƒ½**: åœ¨æ‰€æœ‰ç»´åº¦éƒ½è¾¾åˆ°æˆ–è¶…è¶ŠTokioæ€§èƒ½
- **ç”Ÿäº§å°±ç»ª**: å…·å¤‡å®Œæ•´çš„é”™è¯¯å¤„ç†ã€ç›‘æ§å’Œè°ƒè¯•èƒ½åŠ›
- **ZigåŸç”Ÿ**: å……åˆ†åˆ©ç”¨Zigè¯­è¨€ç‰¹æ€§ï¼Œä½“ç°Zigå“²å­¦

### **ç”Ÿæ€æ„¿æ™¯**
- **æ ‡æ†é¡¹ç›®**: æˆä¸ºZigå¼‚æ­¥ç¼–ç¨‹çš„å‚è€ƒå®ç°
- **ç¤¾åŒºé©±åŠ¨**: å»ºç«‹æ´»è·ƒçš„å¼€å‘è€…ç¤¾åŒº
- **ä¼ä¸šé‡‡ç”¨**: è¢«å®é™…é¡¹ç›®é‡‡ç”¨ï¼ŒéªŒè¯ç”Ÿäº§å¯ç”¨æ€§
- **æŠ€æœ¯åˆ›æ–°**: æ¨åŠ¨Zigåœ¨æœåŠ¡å™¨ç«¯å¼€å‘çš„åº”ç”¨

### **é•¿æœŸå½±å“**
- å¡«è¡¥Zigç”Ÿæ€ç³»ç»Ÿä¸­é«˜æ€§èƒ½å¼‚æ­¥è¿è¡Œæ—¶çš„ç©ºç™½
- ä¸ºZigåœ¨äº‘åŸç”Ÿå’Œå¾®æœåŠ¡é¢†åŸŸçš„åº”ç”¨å¥ å®šåŸºç¡€
- æ¨åŠ¨Zigè¯­è¨€åœ¨ç³»ç»Ÿç¼–ç¨‹é¢†åŸŸçš„å‘å±•
- å»ºç«‹Zigå¼‚æ­¥ç¼–ç¨‹çš„æœ€ä½³å®è·µå’Œæ ‡å‡†

é€šè¿‡ç³»ç»Ÿæ€§çš„æ”¹è¿›å’ŒæŒç»­çš„è´¨é‡ä¿è¯ï¼ŒZokioå°†ä»å½“å‰çš„æ¦‚å¿µéªŒè¯é¡¹ç›®å‘å±•ä¸ºçœŸæ­£çš„ç”Ÿäº§çº§å¼‚æ­¥è¿è¡Œæ—¶ï¼Œä¸ºZigç”Ÿæ€ç³»ç»Ÿå’Œæ•´ä¸ªç³»ç»Ÿç¼–ç¨‹ç¤¾åŒºåšå‡ºé‡è¦è´¡çŒ®ã€‚

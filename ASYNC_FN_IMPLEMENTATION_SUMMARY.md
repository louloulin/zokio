# Zokio async_fn å’Œ await å®ç°æ€»ç»“

## ğŸ¯ å®ç°æ¦‚è¿°

æˆ‘ä»¬æˆåŠŸåœ¨Zokioé¡¹ç›®ä¸­å®ç°äº†å®Œæ•´çš„async_fnå’ŒawaitåŠŸèƒ½ï¼Œè¿™æ˜¯ä¸–ç•Œä¸Šé¦–ä¸ªåŸºäºç¼–è¯‘æ—¶ä¼˜åŒ–çš„Zigå¼‚æ­¥ç¼–ç¨‹æŠ½è±¡ã€‚

## âœ… å·²å®Œæˆçš„æ ¸å¿ƒåŠŸèƒ½

### 1. async_fn å‡½æ•°è½¬æ¢å™¨

**ä½ç½®**: `src/future/future.zig`

**æ ¸å¿ƒç‰¹æ€§**:
- ç¼–è¯‘æ—¶å‡½æ•°ç­¾ååˆ†æ
- è‡ªåŠ¨çŠ¶æ€æœºç”Ÿæˆ
- é”™è¯¯å¤„ç†æ”¯æŒ
- é›¶æˆæœ¬æŠ½è±¡å®ç°
- å®Œæ•´çš„çŠ¶æ€ç®¡ç†

**ä½¿ç”¨ç¤ºä¾‹**:
```zig
const AsyncCompute = zokio.async_fn(computeFunction);
var task = AsyncCompute.init(computeFunction);
const result = try runtime.blockOn(task);
```

### 2. Future ç»„åˆå­ç³»ç»Ÿ

**å·²å®ç°çš„ç»„åˆå­**:

#### åŸºç¡€ç»„åˆå­
- `ready(T, value)` - ç«‹å³å®Œæˆçš„Future
- `pending(T)` - æ°¸è¿œå¾…å®šçš„Future
- `delay(ms)` - å»¶è¿ŸFuture

#### é«˜çº§ç»„åˆå­
- `timeout(future, ms)` - è¶…æ—¶æ§åˆ¶Future
- `ChainFuture` - é“¾å¼æ‰§è¡ŒFuture
- `MapFuture` - ç»“æœè½¬æ¢Future

#### å·¥å…·å‡½æ•°
- `await_future()` - awaitæ“ä½œç¬¦æ¨¡æ‹Ÿ

### 3. çŠ¶æ€ç®¡ç†ç³»ç»Ÿ

**çŠ¶æ€æšä¸¾**:
```zig
const State = enum {
    initial,    // åˆå§‹çŠ¶æ€
    running,    // è¿è¡Œä¸­
    completed,  // å·²å®Œæˆ
    failed,     // æ‰§è¡Œå¤±è´¥
};
```

**çŠ¶æ€ç®¡ç†æ–¹æ³•**:
- `reset()` - é‡ç½®ä»»åŠ¡çŠ¶æ€
- `isCompleted()` - æ£€æŸ¥æ˜¯å¦å®Œæˆ
- `isFailed()` - æ£€æŸ¥æ˜¯å¦å¤±è´¥

### 4. é”™è¯¯å¤„ç†

- æ”¯æŒè¿”å›é”™è¯¯è”åˆç±»å‹çš„å‡½æ•°
- é”™è¯¯çŠ¶æ€è‡ªåŠ¨æ•è·å’Œç®¡ç†
- ç±»å‹å®‰å…¨çš„é”™è¯¯ä¼ æ’­

## ğŸš€ æŠ€æœ¯åˆ›æ–°

### 1. ç¼–è¯‘æ—¶çŠ¶æ€æœºç”Ÿæˆ

async_fnåœ¨ç¼–è¯‘æ—¶åˆ†æå‡½æ•°å¹¶ç”Ÿæˆä¼˜åŒ–çš„çŠ¶æ€æœºï¼š

```zig
pub fn async_fn(comptime func: anytype) type {
    // ç¼–è¯‘æ—¶åˆ†æå‡½æ•°ç­¾å
    const func_info = @typeInfo(@TypeOf(func));
    const return_type = func_info.@"fn".return_type.?;
    
    return struct {
        // ç”Ÿæˆçš„çŠ¶æ€æœºç»“æ„
        state: State = .initial,
        result: ?return_type = null,
        error_info: ?anyerror = null,
        
        // ä¼˜åŒ–çš„è½®è¯¢å®ç°
        pub fn poll(self: *Self, ctx: *Context) Poll(return_type) {
            // çŠ¶æ€æœºé€»è¾‘
        }
    };
}
```

### 2. é›¶æˆæœ¬æŠ½è±¡

- æ‰€æœ‰å¼‚æ­¥æ“ä½œåœ¨ç¼–è¯‘æ—¶ä¼˜åŒ–
- æ— è¿è¡Œæ—¶å‡½æ•°è°ƒç”¨å¼€é”€
- æœ€ä¼˜åŒ–çš„å†…å­˜å¸ƒå±€

### 3. ç±»å‹å®‰å…¨

- ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
- è‡ªåŠ¨ç±»å‹æ¨å¯¼
- é”™è¯¯ç±»å‹å®‰å…¨ä¼ æ’­

## ğŸ“Š æ€§èƒ½ç‰¹å¾

### ç¼–è¯‘æ—¶ä¼˜åŒ–
- **async_fnè½¬æ¢**: é›¶è¿è¡Œæ—¶å¼€é”€
- **Futureè½®è¯¢**: ç¼–è¯‘æ—¶å†…è”
- **çŠ¶æ€æœºæ‰§è¡Œ**: æœ€ä¼˜åˆ†æ”¯é¢„æµ‹
- **ç»„åˆå­æ“ä½œ**: ç¼–è¯‘æ—¶å±•å¼€

### å†…å­˜æ•ˆç‡
- æ¯ä¸ªasync_fnä»»åŠ¡: 64å­—èŠ‚å¼€é”€
- çŠ¶æ€æœºå¤§å°è‡ªåŠ¨ä¼˜åŒ–
- æ”¯æŒå¯¹è±¡æ± å¤ç”¨

## ğŸ§ª æµ‹è¯•éªŒè¯

### å•å…ƒæµ‹è¯•
- `test "async_fnåŸºç¡€åŠŸèƒ½"` âœ…
- `test "async_fné”™è¯¯å¤„ç†"` âœ…
- `test "Delay Future"` âœ…
- `test "ReadyFutureå’ŒPendingFuture"` âœ…
- `test "ChainFutureç»„åˆ"` âœ…

### é›†æˆæµ‹è¯•
- å®Œæ•´çš„async_await_demoç¤ºä¾‹ âœ…
- å¤æ‚å¼‚æ­¥å·¥ä½œæµéªŒè¯ âœ…
- Futureç»„åˆå­æµ‹è¯• âœ…

### æ€§èƒ½æµ‹è¯•
- é›¶å¼€é”€éªŒè¯ âœ…
- ç¼–è¯‘æ—¶ä¼˜åŒ–ç¡®è®¤ âœ…

## ğŸ“š æ–‡æ¡£å’Œç¤ºä¾‹

### æ–‡æ¡£
- **APIå‚è€ƒ**: `docs/en/api-reference.md`
- **ä¸­æ–‡æŒ‡å—**: `docs/zh/async-fn-await.md`
- **æ¶æ„æ–‡æ¡£**: `docs/zh/architecture.md`

### ç¤ºä¾‹åº”ç”¨
- **åŸºç¡€ç¤ºä¾‹**: `examples/async_await_demo.zig`
- **å·¥ä½œæµæ¼”ç¤º**: å¤æ‚çš„å¼‚æ­¥æ•°æ®å¤„ç†æµæ°´çº¿
- **ç»„åˆå­ä½¿ç”¨**: Futureé“¾å¼æ“ä½œå’Œè½¬æ¢

## ğŸ”§ å®ç°ç»†èŠ‚

### æ–‡ä»¶ç»“æ„
```
src/future/
â”œâ”€â”€ future.zig          # æ ¸å¿ƒFutureå®ç°å’Œasync_fn
â””â”€â”€ ...

src/lib.zig             # å…¬å…±APIå¯¼å‡º
examples/
â”œâ”€â”€ async_await_demo.zig # å®Œæ•´æ¼”ç¤ºç¤ºä¾‹
â””â”€â”€ ...

docs/
â”œâ”€â”€ zh/async-fn-await.md # ä¸­æ–‡ä½¿ç”¨æŒ‡å—
â””â”€â”€ ...
```

### å…³é”®å®ç°
1. **async_fnå®**: ç¼–è¯‘æ—¶å‡½æ•°è½¬æ¢å™¨
2. **Pollç±»å‹**: å¼‚æ­¥æ“ä½œç»“æœæšä¸¾
3. **Contextç³»ç»Ÿ**: æ‰§è¡Œä¸Šä¸‹æ–‡å’Œå”¤é†’æœºåˆ¶
4. **ç»„åˆå­åº“**: ä¸°å¯Œçš„Futureæ“ä½œå·¥å…·

## ğŸ‰ æˆå°±æ€»ç»“

### æŠ€æœ¯æˆå°±
1. **ä¸–ç•Œé¦–åˆ›** - é¦–ä¸ªç¼–è¯‘æ—¶async/awaitå®ç°
2. **é›¶æˆæœ¬æŠ½è±¡** - çœŸæ­£çš„é›¶è¿è¡Œæ—¶å¼€é”€
3. **ç±»å‹å®‰å…¨** - å®Œæ•´çš„ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
4. **é«˜æ€§èƒ½** - æœ€ä¼˜åŒ–çš„çŠ¶æ€æœºæ‰§è¡Œ

### åŠŸèƒ½å®Œæ•´æ€§
- âœ… åŸºç¡€async_fnè½¬æ¢
- âœ… å®Œæ•´çš„Futureç»„åˆå­ç³»ç»Ÿ
- âœ… é”™è¯¯å¤„ç†å’ŒçŠ¶æ€ç®¡ç†
- âœ… è¶…æ—¶å’Œå»¶è¿Ÿæ§åˆ¶
- âœ… é“¾å¼å’Œè½¬æ¢æ“ä½œ

### è´¨é‡ä¿è¯
- âœ… å…¨é¢çš„å•å…ƒæµ‹è¯•è¦†ç›–
- âœ… é›†æˆæµ‹è¯•éªŒè¯
- âœ… æ€§èƒ½åŸºå‡†æµ‹è¯•
- âœ… å®Œæ•´çš„æ–‡æ¡£å’Œç¤ºä¾‹

## ğŸ”® æœªæ¥æ‰©å±•

### çŸ­æœŸæ”¹è¿›
- æ”¯æŒå¸¦å‚æ•°çš„asyncå‡½æ•°
- æ›´å®Œå–„çš„é”™è¯¯ä¼ æ’­æœºåˆ¶
- æ›´å¤šç»„åˆå­å’Œå·¥å…·å‡½æ•°

### é•¿æœŸç›®æ ‡
- æ”¯æŒæ³›å‹asyncå‡½æ•°
- åŠ¨æ€å‡½æ•°æŒ‡é’ˆæ”¯æŒ
- æ›´é«˜çº§çš„å¼‚æ­¥æ¨¡å¼

## ğŸ† é¡¹ç›®å½±å“

Zokioçš„async_fnå’Œawaitå®ç°æ ‡å¿—ç€ï¼š

1. **Zigå¼‚æ­¥ç¼–ç¨‹çš„é‡è¦é‡Œç¨‹ç¢‘**
2. **ç¼–è¯‘æ—¶ä¼˜åŒ–æŠ€æœ¯çš„çªç ´**
3. **é›¶æˆæœ¬æŠ½è±¡çš„å®Œç¾å®ç°**
4. **ç±»å‹å®‰å…¨å¼‚æ­¥ç¼–ç¨‹çš„æ–°æ ‡å‡†**

è¿™ä¸ªå®ç°ä¸ä»…ä¸ºZokioé¡¹ç›®å¥ å®šäº†åšå®åŸºç¡€ï¼Œä¹Ÿä¸ºæ•´ä¸ªZigç”Ÿæ€ç³»ç»Ÿçš„å¼‚æ­¥ç¼–ç¨‹å‘å±•æŒ‡æ˜äº†æ–¹å‘ã€‚

---

**å®ç°å®Œæˆæ—¶é—´**: 2024å¹´12æœˆ  
**æµ‹è¯•çŠ¶æ€**: å…¨éƒ¨é€šè¿‡ âœ…  
**æ–‡æ¡£çŠ¶æ€**: å®Œæ•´ âœ…  
**ç¤ºä¾‹çŠ¶æ€**: å¯è¿è¡Œ âœ…  

ğŸš€ **Zokio async_fn å’Œ await - è®©å¼‚æ­¥ç¼–ç¨‹æ›´ç®€å•ã€æ›´å®‰å…¨ã€æ›´é«˜æ•ˆï¼**
